<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lectura de Datos de Firestore</title>
    <style>
        body { font-family: sans-serif; margin: 20px; margin:0; padding:0; }
        .data-item { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        .error { color: red; }
        .main-menu {
            position: relative;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: flex-end;
            top: 0;
            right: 0;
            background-color: #1976d2;
            color: white;
            font-weight: bold;
            cursor: move;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            user-select: none;
            width: 100%;
        }
        #user_icon {
            display: flex;
            align-items: center;
            flex-direction: column;
            cursor:pointer;
            &:hover {
                background-color: #1976d2;
            }
            & img{
                border-radius: 50%;
            }
        }
        #data_mediciones{
            display: flex;
            flex-direction: column;
            align-items: baseline;
            padding: 10px;
            & .item_title{
                font-weight: bold;
                width: 100%;
                background-color: #1976d2;
                color: white;
            }
            & .data_item{
                width: auto;
                padding: 10px;
                border: 1px solid #1976d2;
                border-radius: 5px;
                margin-bottom: 10px;
            }
            & .data_mediciones_day{
                width:100%;
            }
        }

    </style>
    <script src="./js/ndialogo/ndialogo.js"></script>
    <link rel="stylesheet" href="./js/ndialogo/ndialogo.css">
</head>
<body>
    <div class="main-menu">
        <div id="user_icon">
            <img src="./img/usuario.png" alt="Foto de perfil" style="width: 50px;">
            <div>Usuario</div>
        </div>
    </div>
    <h1>Mis Datos de Firestore</h1>
    <a href="login.html">login</a>
    <button onclick="add_medicion_dlg();">Agregar Medicion</button>
    <div id="data_contenedor">
        <div id="data_grafico">

        </div>
        <div id="data_mediciones">

        </div>
    </div>





    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <script>
        const user_icon = document.getElementById('user_icon');

        const dlg_intermedio = new Ndialogo();
        const dlg = new Ndialogo();
        user_icon.addEventListener('click', async () => {
            
            if(auth.currentUser){
                dlg.open(`Espere...`,false);
                const doc = await db.collection("usuario").doc(auth.currentUser.uid).get();
                dlg.close();
                if (doc.exists) {
                    const data =  doc.data();
                    dlg_intermedio.open(`
                        <div class="data-item">
                            <img src="${data.photoURL}" alt="Foto de perfil" style="width:50px; height: 50px;border-radius: 50%;">
                            <strong>Nombre:</strong> ${data.displayName}<br>
                            <strong>email:</strong> ${data.email}<br>
                            <button id="sign-out-button" class="hidden">Cerrar Sesión</button>
                        </div>
                    `, true);
                    document.getElementById('sign-out-button').addEventListener('click', () => {
                        auth.signOut();
                        dlg_intermedio.close();
                    });
                } else {
                    console.log("No such document!");
                }
            } else {
                dlg_intermedio.open(`
                    <div class="data-item">
                        <button id="sign-in-button-google" class="hidden">Iniciar Sesión Google</button>
                        <button id="sign-in-button-facebook" class="hidden">Iniciar Sesión Facebook</button>
                    </div>
                `, true);

                const signInButtonGoogle = document.getElementById('sign-in-button-google');
                signInButtonGoogle.addEventListener('click', ()=>{signIn('goolgle')});

                const signInButtonFacebook = document.getElementById('sign-in-button-facebook');
                signInButtonFacebook.addEventListener('click', ()=>{signIn('facebook')});
            }
        });
        const firebaseConfig = {
            apiKey: "AIzaSyDo30GmrPeIYn31jQNIaoWIC85Eew8gu_E",
            authDomain: "carga-de-datos-e6203.firebaseapp.com",
            projectId: "carga-de-datos-e6203",
            storageBucket: "carga-de-datos-e6203.firebasestorage.app",
            messagingSenderId: "138191639020",
            appId: "1:138191639020:web:1962468915082ccff530c9",
            measurementId: "G-G4NQ7XX45W"
        };

        const signIn = async (proveedor)=>{
                    
            try {
                // signInWithPopup abre una ventana emergente para la autenticación
                let result;
                if(proveedor === 'goolgle'){
                    result = await auth.signInWithPopup(providerGoogle);
                    // resutl = await auth.signInWithRedirect(providerGoogle);
                }
                if(proveedor === 'facebook'){
                    result = await auth.signInWithPopup(providerFacebook);
                }

                // console.log("Usuario autenticado:", result.user);
                dlg.close();
                dlg_intermedio.close();
                // El estado de autenticación será manejado por onAuthStateChanged

            } catch (error) {
                console.error("Error al iniciar sesión con Google:", error);
                statusElement.innerText = `Error al iniciar sesión: ${error.message}`;
                // Manejar errores como el cierre de la ventana emergente por el usuario
            }

        }



        // Inicializa Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const auth = firebase.auth();
        const providerGoogle = new firebase.auth.GoogleAuthProvider();
        const providerFacebook = new firebase.auth.FacebookAuthProvider();


        const medicion_tipo_data = {};

        // Función para leer y mostrar los datos
        async function readFirestoreData() {
            try {
                const medicion_tipo_colection = await db.collection("medicion_tipo").get();
                
                if (medicion_tipo_colection.empty) {
                    console.log('No hay documentos en la colección "medicion_tipo"');
                    return;
                }

                medicion_tipo_colection.forEach((doc) => {
                    const data = doc.data();
                    const docId = doc.id;
                    medicion_tipo_data[docId] = data;
                });
                console.log('medicion_tipo',medicion_tipo_data);
            } catch (error) {
                console.error("Error al leer datos de Firestore: ", error);
            }
        }

        async function read_medicion_tipo() {
            try {
                const medicion_tipo_colection = await db.collection("medicion_tipo").get();
                
                if (medicion_tipo_colection.empty) {
                    // console.log('No hay documentos en la colección "medicion_tipo"');
                    return {
                        ok: false,
                        error_msg: 'No hay documentos en la colección "medicion_tipo"',
                        error_code: 404,
                    };
                }
                const result = [];
                medicion_tipo_colection.forEach((doc) => {
                    const data = doc.data();
                    const docId = doc.id;
                    result.push({
                        id: docId,
                        data: data,
                    });
                });
                return {
                    ok: true,
                    data: {
                        medicion_tipo: result,
                    },
                };
            } catch (error) {
                // console.error("Error al leer datos de Firestore: ", error);
                return {
                    ok: false,
                    error_msg: error.message,
                    error_code: error.code,
                };
            }
        }


        auth.onAuthStateChanged(async (user) => {
            if (!user) { // Si no hay usuario conectado
                user_icon.innerHTML = `
                    <img src="./img/usuario.png" alt="Foto de perfil" style="width:50px;height:50px; border-radius: 50%;">
                    <div>Usuario</div>
                `;
                console.log('usuario deslogeado');  
                return;
            }

            user_icon.innerHTML = `
            <img src="${user.photoURL}" alt="Foto de perfil" style="width:50px; height:50px; border-radius: 50%;">
            
            <div>${user.displayName || user.email}</div>
            `;
            console.log('usuario logeado');

            // Actualiza usuario en Firestore
            try {
                const userDocRef = db.collection("usuario").doc(user.uid);
                const doc = await userDocRef.get();

                if (!doc.exists) {
                    // El usuario no existe en Firestore, lo creamos
                    await userDocRef.set({
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName,
                        photoURL: user.photoURL,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(), // Marca de tiempo del servidor
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log("Nuevo usuario creado en Firestore:", user.uid);

                } else {
                    // El usuario ya existe, simplemente actualizamos la fecha de último inicio de sesión
                    await userDocRef.update({
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log("Usuario existente en Firestore actualizado:", user.uid);
                    // statusElement.innerText += " (Último inicio de sesión actualizado en Firestore.)";
                }
            } catch (firestoreError) {
                console.log("Error al gestionar el usuario en Firestore:", firestoreError);
                statusElement.innerText += ` (Error en Firestore: ${firestoreError.message})`;
            }

            // Lee los datos de del usuario
            readFirestoreUserData();
        });

        // Llama a la función cuando la página se carga
        window.onload = ()=>{
            readFirestoreData();
        };

        const readFirestoreUserData = async()=>{
            // si está logeado lee la subcoleccion 'medicion'
            if(auth.currentUser){
                try {
                    const querySnapshot = await db.collection("usuario/" + auth.currentUser.uid + "/medicion")
                    .orderBy('fechayhora','desc')
                    .get();
                    
                    const mediciones = [];
                    const data_mediciones = document.getElementById('data_mediciones');
                    data_mediciones.innerHTML = '';
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const docId = doc.id;
                        const tipo = data.tipo;
                        const fecha = data.fechayhora.toDate().toISOString('en-US').slice(0, 10);
                        const hora = data.fechayhora.toDate().toLocaleTimeString('en-US', { hour12: false });
                        mediciones.push(data);
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'data_item';
                        itemDiv.innerHTML = `
                            <strong>ID del Documento:</strong> ${docId}<br>
                            <strong>fecha y hora:</strong> ${fecha+' '+hora}<br>
                            <strong>fecha:</strong> ${fecha}<br>
                            <strong>hora:</strong> ${hora}<br>
                            <strong>tipo:</strong> ${medicion_tipo_data[tipo]?medicion_tipo_data[tipo].nombre:''}<br>
                            <strong>valor:</strong> ${data.medicion_valor} ${medicion_tipo_data[tipo]?medicion_tipo_data[tipo].unidad:''}<br>
                            <strong>contexto:</strong> ${data.medicion_contexto}<br>

                        `;
                        let data_mediciones_day = data_mediciones.querySelector(`[data-day="${fecha}"]`);
                        if (!data_mediciones_day) {
                            data_mediciones_day = document.createElement('div');
                            data_mediciones_day.className = 'data_mediciones_day';
                            data_mediciones_day.setAttribute('data-day', fecha);
                            data_mediciones_day.innerHTML = `<div class="item_title">${fecha}</div>`;
                            data_mediciones.appendChild(data_mediciones_day);
                        }   
                        data_mediciones_day.appendChild(itemDiv);
                        
                    });
                    console.log('mediciones',mediciones.map(medicion =>{
                        // transforma fecha a string
                        let fecha = medicion.fechayhora.toDate().toISOString().slice(0, 19).replace('T', ' ');
                        return {...medicion, fechayhora:fecha};
                        
                    }));
                } catch (error) {
                    console.error("Error al leer datos de Firestore: ", error);
                    dataContainer.innerHTML = `<p class="error">Error al cargar los datos: ${error.message}</p>`;
                }
            }
        }

        const add_medicion_dlg = async()=>{
            if(!auth.currentUser){
                return;
            }

            dlg.open(`Espere...`,false);
            const a = await read_medicion_tipo();
            dlg.close();
            if(!a.ok){
                dlg.open('<div>'+ a.error_msg+ a.error_code+'</div>',false);
                return;
            }
            dlg_intermedio.setTitle('Agregar Medicion');
            dlg_intermedio.open(`<div style="display: flex; flex-direction: column; gap: 10px;">
                <label for="medicion_tipo">Tipo de Medicion:</label>
                <select id="medicion_tipo" name="medicion_tipo" onchange="console.log(this);">
                    ${a.data.medicion_tipo.map((medicion_tipo) => `<option value="${medicion_tipo.id}">${medicion_tipo.data.nombre}</option>`).join('')}
                </select>
                <label for="medicion_fecha">Fecha:</label>
                <input type="date" id="medicion_fecha" name="medicion_fecha" value="${new Date().toISOString().split('T')[0]}">
                <label for="medicion_hora">Hora:</label>
                <input type="time" id="medicion_hora" name="medicion_hora" value="${new Date().toLocaleTimeString()}">
                <label for="medicion_valor">Valor:</label>
                <input type="number" step="0.01" id="medicion_valor" name="medicion_valor">
                <label for="medicion_contexto">Contexto:</label>
                <input type="text" id="medicion_contexto" name="medicion_contexto">
                <div>
                    <button id="add_medicion_btn">Agregar Medicion</button>
                    <button onclick="dlg_intermedio.close();">Cancelar</button>
                </div>

                </div>
            `);
            const add_medicion_btn = document.getElementById('add_medicion_btn');
            add_medicion_btn.addEventListener('click', async () => {
                const medicion_tipo = document.getElementById('medicion_tipo').value;
                const medicion_fecha = document.getElementById('medicion_fecha').value;
                const medicion_hora = document.getElementById('medicion_hora').value;
                const medicion_valor = document.getElementById('medicion_valor').value;
                const medicion_contexto = document.getElementById('medicion_contexto').value;
                const data = {medicion_tipo, medicion_fecha, medicion_hora, medicion_valor, medicion_contexto};

                dlg.open('Espere...', false);
                const result = await add_medicion(data);
                dlg.close();
                if (!result.ok){
                    dlg.open(`<div>${result.error_msg} ${result.error_code}</div>`, true);
                    return;
                }
                dlg_intermedio.close();
            });

            const add_medicion = async (data) => {
                // console.log(data);
                try {
                    data.fechayhora = firebase.firestore.Timestamp.fromDate(new Date(data.medicion_fecha + ' ' + data.medicion_hora));
                    delete data.medicion_fecha;
                    delete data.medicion_hora;

                    const docRef = db.collection("usuario/" + auth.currentUser.uid + "/medicion").doc();
                    await docRef.set(data);
                    return {ok: true};
                } catch (error) {
                    return {ok: false, error_msg: error.message, error_code: error.code};
                }
            }
        }
            
    </script>
</body>
</html>
